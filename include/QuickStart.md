# Building a Raspberry Pi based ultrasound imaging development platform


[](@description Using a Raspberry Pi to image)

## Introduction

This project has a specific target of providing a __low-cost, open source technological kit to allow scientists, academics, hackers, makers or OSHW fans to hack their way to ultrasound imaging__ - below 500$ - at home, with no specific equipment required. 

### Objective

The aim of this project is to build a small ultrasound imaging hardware and software development kit, with the specific goal of:

- building an _analog "debugging tool"_ to explore ultrasound imaging systems. 
- consolidating [existing hardware research](http://openhardware.metajnl.com/articles/10.5334/joh.2/);
- simplifing / lowering the cost of the kit;
- providing a benchmark of ultrasound systems;
- introducing a simple API to control hardware;
- having a server which provides raw ultrasound data, and for ultrasound imaging, can deliver standard DICOM files;
- having a kit that can be used for pedagogical and academic purposes - not to mention people who want to understand ultrasound!

Previous project has shown the feasibility of the hardware, but was not simple enough. Let's keep the momentum, and use this dev kit in other projects as well - such as dopplers or non-destructive testing, different projects using piezos as sensors.

## Architecture

Ultrasound imaging has evolved since the first ultrasound machine appeared. The first devices were using single-sensor (transducers) techniques, coupled with mechanical scanning - hence allowing a single signal processing channel. The architecture of such systems, as shown below, is well-known and formed the basis of ultrasound imaging.


![](http://openhardware.metajnl.com/articles/10.5334/joh.2/joh-1-2-g1.png/?action=download)


This kit consists of several modules mainly built from easily available components - after a short benchmark of [existing ICs](https://kelu124.gitbooks.io/echomods/content/Chapter6/bench.html). Two electronic modules were specifically designed to provide the basic development kit. 

* the __Transducer Pulser Module (TPM)__: designed to provide a precise high-voltage pulse, necessary to excite the sensor, while remaining robust enough to be controlled by an Arduino;
* the __Analog Processing Module (APM)__: designed to correctly process the raw ultrasound electric signal, while easily exposing all intermediary signals, and exposing a digital output to the user
* the __RPi high-speed ADC__ uses two interleaved AD9200, clocked with the RPi, which reads at 11Msps, leading to an effective 22Msps acquisition speed (bottleneck being the RPi copying the ADC values through the GPIOs register to RAM). The signals can be read as is (eg in case of analog enveloppe detection) or offset by Vref/2 (to acquire the raw signal). Due to the GPIO necessary to run the modules, we are left with 2x9 GPIO left, resulting in a 22Msps, 9 bit ADC. One or two logic signals can additionaly be sampled - for an external motor hall sensor for example.

A modular approach was chosen to ensure that each key component inside the ultrasound image processing can easily be replaced and compared with another module. Each electronic module takes the place of a function in the signal processing chain or allows tapping into the different signals circulating between the blocks. 

Previous experiments have been done, to get images using different digital acquisition systems, such as a bitscope, a STM32, or a high-speed ADC for beaglebone. The Raspberry Pi was retained in the end for its ease of use, its price, and community working on it - increasing the potential reach of the project. 

## Assembly guide 

### Required materials

* A [pulser board](/tobo/) - to generate the high voltage pulse to use the transducer
* An [analog front end](/goblin/) - to amplify the weak signals generated by the echoes
* an [ADC cape](/elmo/) - a custom made 11Msps to 22Msps ADC pHAT for Raspberries.
* a [Raspberry Pi, 0 or W](/tomtom/) to manage everything
* the [motherboard, v2](/doj/) - to connect the different modules together
* and some extras such as headers, jumpers, and a smallish OLED screen

For the transducer, one can use either a [ATL mechanical probe](/retroATL3/) for example, or a [piezo + servo setup](/cletus), to mechanically scan the medium to be imaged 












## Quickstart of the Pulser module

### The [pulser](/tobo/) module

The assembly is detailed below:

![](/tobo/images/QS_tobo.jpg)

Read more on [the dedicated page](/tobo/).

### Controlling the pulser

The pulser is controled by a double signal, one, _PulseOn_, to start the pulse, and the other, _PulseOff_, to bring the pulse back to 0. 

__Note__: The setup presented here was with the [Raspberry Pi + ADC setup](/elmo/data/arduino/20170611-arduino.md). Raspberry Pi kernel modules and software can be found following the previous link.

The _PulseOn_, _PulseOff_ and signal output are represented below.

### Controls

Yellow is PulseOn, Blue is PulseOff. The logic is also 3.3V and 5V tolerant. Here, the control signals were produced with a raspberry pi. 


#### Controls

![](/tobo/images/2017/TEK0007.JPG)

#### Output on the pulser SMA to transducer

![](/tobo/images/2017/TEK0009.JPG)




## Quickstart of the mother board

## BEWARE !!

As a piece of advice, __don't solder your modules directly on the motherboard__... unless you're sure that they are properly set up, that there's no short, ... and keep the design as modular as possible.

Instead, solder header, 19 slot long, for each side of the modules. These will be the host for the pins coming from the different modules.

Nothing can keep you from soldering round slot headers for ease of using wire jumpers.

Don't forget to put some capacitance on the dedicated slots on the motherboard to smooth the supply - and on Doj v2, to include the 3.3V jumper (above the 5V capa) so that the Pi can provide the necessary 3.3V to the board, and, if using a Pi, to solder the Pon <-> Pon3 and  Poff <-> Poff3 if you want to use a pulser at 3.3V from the Pi.

### Doj v1.2

The PCB can be ordered on [OSHPark](https://oshpark.com/shared_projects/bdv4Rw1z) - or ask me if I have one available (maybe check on [Tindie](https://www.tindie.com/products/kelu124/ultrasound-modules-motherboard/))

#### How to solder the PCB ?

![](/doj/images/doj12.jpg)

#### Example of Doj v2 powered through Raspberry USB 	

![](/doj/images/20170406_214508.jpg)



### Doj v2

The PCB can be ordered on [OSHPark](https://oshpark.com/shared_projects/rAatPbRg) - or ask me if I have one available.

#### How to solder the PCB ?

![](/doj/images/doj20.jpg)

#### Example of Doj v2 powered through the [Feather](/goblin/) module

![](/doj/images/doj_v2_notes.jpg)







## Quickstart of the APM module


### The [Analog Processing Board](/goblin/) module

The assembly is detailed below:

![](/goblin/images/QS_goblin.jpg)

Specific points:
* A couple of headers to solder.
* Don't bother soldering SPI (the white header) if you don't plan on using it
* Setup the small jumper (in blue) to get signal from the "Raw Track". Other position is to get signal from SMA. Beware, there's no signal clipping there on this board.
* Setup the small jumper (in red) to get constant gain for TGC from the pot circle in dark red. The other position can be used if you plan on using the "GAIN" track (between 0 to 1V) to control the gain.

Read more on [the dedicated page](/goblin/).

## Testing and calibrating Tobo

Apply a small voltage on Raw Track with jumpers rightly positioned (A). You should get a amplified signal on track RawSig (B), the offset  enveloppe on REnv track (C), and envelopped of the signal on 

BEWARE! Only apply small voltages to input (less than 1 Vpp ideally, here calibration was done with 60mVpp signals) 

![](/goblin/images/slide_principle.png)





[](@autogenerated - invisible comment)